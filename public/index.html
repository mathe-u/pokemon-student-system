<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Sistema de Alunos Pokémon</title>
</head>

<body>
    <div class="container">
        <h1>🎓 Sistema de Alunos Pokémon</h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">👥 Alunos</button>
            <button class="tab" onclick="showTab('register-student')">➕ Cadastrar Aluno</button>
            <button class="tab" onclick="showTab('manage-activities')">📋 Gerenciar Atividades</button>
            <button class="tab" onclick="showTab('activities')">📝 Atribuir Pontos</button>
            <button class="tab" onclick="showTab('ranking')">🏆 Ranking</button>
        </div>

        <div id="message-container"></div>

        <!-- Cadastrar Aluno -->
        <div id="register-student" class="tab-content">
            <div class="form-section">
                <h2>📝 Cadastrar Novo Aluno</h2>
                <form id="student-form">
                    <div class="form-group">
                        <label for="student-name">Nome do Aluno:</label>
                        <input type="text" id="student-name" required placeholder="Digite o nome do aluno">
                    </div>
                    <div class="form-group">
                        <label for="pokemon-choice">Escolha seu Pokémon:</label>
                        <select id="pokemon-choice" required>
                            <option value="">Selecione um Pokémon</option>
                            <option value="bulbasaur">🌱 Bulbasaur</option>
                            <option value="charmander">🔥 Charmander</option>
                            <option value="squirtle">💧 Squirtle</option>
                        </select>
                    </div>
                    <button type="submit" id="student-submit-btn">Cadastrar Aluno</button>
                </form>
            </div>
        </div>

        <!-- Gerenciar Atividades -->
        <div id="manage-activities" class="tab-content">
            <div class="form-section">
                <h2>📋 Criar Nova Atividade</h2>
                <form id="create-activity-form">
                    <div class="form-group">
                        <label for="new-activity-name">Nome da Atividade:</label>
                        <input type="text" id="new-activity-name" required
                            placeholder="Ex: Prova de Matemática, Trabalho de História...">
                    </div>
                    <div class="form-group">
                        <label for="new-activity-points">Pontuação Padrão:</label>
                        <input type="number" id="new-activity-points" required min="1" max="100"
                            placeholder="Pontuação sugerida (1-100)">
                    </div>
                    <div class="form-group">
                        <label for="activity-description">Descrição (opcional):</label>
                        <input type="text" id="activity-description" placeholder="Breve descrição da atividade">
                    </div>
                    <button type="submit" id="activity-submit-btn">Criar Atividade</button>
                </form>
            </div>

            <div class="form-section">
                <h3>📝 Atividades Criadas</h3>
                <div id="created-activities-list"></div>
            </div>
        </div>

        <!-- Listar Alunos -->
        <div id="students" class="tab-content active">
            <h2>👥 Alunos Cadastrados</h2>
            <div id="students-list" class="grid"></div>
        </div>

        <!-- Atividades -->
        <div id="activities" class="tab-content">
            <div class="form-section">
                <h2>📝 Atribuir Pontos</h2>
                <form id="activity-form">
                    <div class="form-group">
                        <label for="student-select">Aluno:</label>
                        <select id="student-select" required>
                            <option value="">Selecione um aluno</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="activity-select">Atividade:</label>
                        <select id="activity-select" required>
                            <option value="">Selecione uma atividade</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="activity-points">Pontuação:</label>
                        <input type="number" id="activity-points" required min="1" max="100"
                            placeholder="Digite a pontuação (1-100)">
                    </div>
                    <button type="submit" id="assign-activity-btn">Atribuir Pontos</button>
                </form>
            </div>
        </div>

        <!-- Ranking -->
        <div id="ranking" class="tab-content">
            <div class="form-section">
                <h2>🏆 Top 5 Alunos</h2>
                <div class="form-group">
                    <label for="pokemon-filter">Filtrar por Pokémon:</label>
                    <select id="pokemon-filter" onchange="displayRanking()">
                        <option value="all">🌟 Todos os Pokémons</option>
                        <option value="bulbasaur">🌱 Família Bulbasaur</option>
                        <option value="charmander">🔥 Família Charmander</option>
                        <option value="squirtle">💧 Família Squirtle</option>
                    </select>
                </div>
            </div>
            <div id="ranking-list" class="ranking-list"></div>
        </div>
    </div>

    <script>
        // Configuração da API
        const API_BASE_URL = '/api';

        // Dados dos Pokémons e suas evoluções
        const pokemonData = {
            bulbasaur: {
                stages: ['🌱 Bulbasaur', '🌿 Ivysaur', '🌸 Venusaur'],
                emojis: ['🌱', '🌿', '🌸'],
                images: [
                    'images/0001Bulbasaur.png',
                    'images/002Ivysaur.png',
                    'images/0003Venusaur.png'
                ]
            },
            charmander: {
                stages: ['🔥 Charmander', '🔥 Charmeleon', '🔥 Charizard'],
                emojis: ['🔥', '🔥', '🔥'],
                images: [
                    'images/0004Charmander.png',
                    'images/005Charmeleon.png',
                    'images/0006Charizard.png'
                ]
            },
            squirtle: {
                stages: ['💧 Squirtle', '💧 Wartortle', '💧 Blastoise'],
                emojis: ['💧', '💧', '💧'],
                images: [
                    'images/0007Squirtle.png',
                    'images/0008Wartortle.png',
                    'images/0009Blastoise.png'
                ]
            }
        };

        // Variáveis globais para armazenar dados
        let students = [];
        let activities = [];
        let createdActivities = [];

        // Funções utilitárias para API
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Erro na API');
                }

                return data;
            } catch (error) {
                console.error('Erro na API:', error);
                throw error;
            }
        }

        // Carregar dados da API
        async function loadStudents() {
            try {
                const response = await apiRequest('/students');
                students = response.data;
            } catch (error) {
                showMessage('Erro ao carregar estudantes: ' + error.message, 'error');
                students = [];
            }
        }

        async function loadCreatedActivities() {
            try {
                const response = await apiRequest('/created-activities');
                createdActivities = response.data;
            } catch (error) {
                showMessage('Erro ao carregar atividades: ' + error.message, 'error');
                createdActivities = [];
            }
        }

        async function loadActivities() {
            try {
                const response = await apiRequest('/activities');
                activities = response.data;
            } catch (error) {
                showMessage('Erro ao carregar atividades atribuídas: ' + error.message, 'error');
                activities = [];
            }
        }

        // Funções de navegação entre abas
        async function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Carregar dados conforme necessário
            if (tabName === 'students') {
                await loadStudents();
                displayStudents();
            } else if (tabName === 'ranking') {
                await loadStudents();
                displayRanking();
            } else if (tabName === 'activities') {
                await loadStudents();
                await loadCreatedActivities();
                updateStudentSelect();
                updateActivitySelect();
            } else if (tabName === 'manage-activities') {
                await loadCreatedActivities();
                displayCreatedActivities();
            }
        }

        // Função para mostrar mensagens
        function showMessage(text, type = 'success') {
            const container = document.getElementById('message-container');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            container.innerHTML = '';
            container.appendChild(message);

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Função para adicionar loading ao botão
        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.classList.add('btn-loading');
                button.innerHTML = '<span class="loading"></span> Processando...';
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                // Restaurar texto original baseado no ID
                const originalTexts = {
                    'student-submit-btn': 'Cadastrar Aluno',
                    'activity-submit-btn': 'Criar Atividade',
                    'assign-activity-btn': 'Atribuir Pontos'
                };
                button.innerHTML = originalTexts[buttonId] || 'Enviar';
            }
        }

        // Função para calcular nível de evolução baseado na pontuação
        function getEvolutionLevel(points) {
            return Math.min(2, Math.floor(points / 100));
        }

        // Função para obter informações do Pokémon
        function getPokemonInfo(type, evolutionLevel) {
            const pokemon = pokemonData[type];
            return {
                name: pokemon.stages[evolutionLevel],
                emoji: pokemon.emojis[evolutionLevel],
                image: pokemon.images[evolutionLevel]
            };
        }

        // Criar nova atividade
        document.getElementById('create-activity-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            setButtonLoading('activity-submit-btn', true);

            try {
                const name = document.getElementById('new-activity-name').value.trim();
                const defaultPoints = parseInt(document.getElementById('new-activity-points').value);
                const description = document.getElementById('activity-description').value.trim();

                const response = await apiRequest('/created-activities', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        defaultPoints,
                        description
                    })
                });

                showMessage(response.message);
                document.getElementById('create-activity-form').reset();
                await loadCreatedActivities();
                displayCreatedActivities();
                updateActivitySelect();

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setButtonLoading('activity-submit-btn', false);
            }
        });

        // Cadastrar aluno
        document.getElementById('student-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            setButtonLoading('student-submit-btn', true);

            try {
                const name = document.getElementById('student-name').value.trim();
                const pokemonType = document.getElementById('pokemon-choice').value;

                const response = await apiRequest('/students', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        pokemonType
                    })
                });

                showMessage(response.message);
                document.getElementById('student-form').reset();
                await loadStudents();
                updateStudentSelect();

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setButtonLoading('student-submit-btn', false);
            }
        });

        // Adicionar atividade
        document.getElementById('activity-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            setButtonLoading('assign-activity-btn', true);

            try {
                const studentId = parseInt(document.getElementById('student-select').value);
                const activityId = parseInt(document.getElementById('activity-select').value);
                const points = parseInt(document.getElementById('activity-points').value);

                const response = await apiRequest('/activities', {
                    method: 'POST',
                    body: JSON.stringify({
                        studentId,
                        activityId,
                        points
                    })
                });

                let message = response.message;

                if (response.data && response.data.evolved) {
                    const pokemonInfo = getPokemonInfo(
                        response.data.student.pokemonType,
                        response.data.newLevel
                    );
                    message += ` 🎉 ${response.data.student.name} evoluiu para ${pokemonInfo.name}!`;
                }

                showMessage(message);
                document.getElementById('activity-form').reset();

                // Recarregar dados para refletir mudanças
                await loadStudents();
                await loadActivities();

            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                setButtonLoading('assign-activity-btn', false);
            }
        });

        // Atualizar select de atividades
        function updateActivitySelect() {
            const select = document.getElementById('activity-select');
            const pointsInput = document.getElementById('activity-points');

            select.innerHTML = '<option value="">Selecione uma atividade</option>';

            createdActivities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.id;
                option.textContent = activity.name;
                option.setAttribute('data-points', activity.defaultPoints);
                select.appendChild(option);
            });

            // Auto-preencher pontuação quando selecionar atividade
            select.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.hasAttribute('data-points')) {
                    pointsInput.value = selectedOption.getAttribute('data-points');
                } else {
                    pointsInput.value = '';
                }
            });
        }

        // Exibir atividades criadas
        function displayCreatedActivities() {
            const container = document.getElementById('created-activities-list');

            if (createdActivities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Nenhuma atividade criada ainda. 📝</p>';
                return;
            }

            container.innerHTML = '';

            createdActivities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-info">
                        <div class="activity-name">${activity.name}</div>
                        <div class="activity-meta">
                            ${activity.description ? activity.description + ' • ' : ''}
                            Pontuação padrão: ${activity.defaultPoints}
                        </div>
                    </div>
                    <div class="activity-points">${activity.defaultPoints} pts</div>
                    <button class="delete-btn" onclick="deleteActivity(${activity.id})">🗑️</button>
                `;
                container.appendChild(item);
            });
        }

        // Deletar atividade
        async function deleteActivity(activityId) {
            if (confirm('Tem certeza que deseja excluir esta atividade?')) {
                try {
                    const response = await apiRequest(`/created-activities/${activityId}`, {
                        method: 'DELETE'
                    });

                    showMessage(response.message);
                    await loadCreatedActivities();
                    displayCreatedActivities();
                    updateActivitySelect();

                } catch (error) {
                    showMessage(error.message, 'error');
                }
            }
        }

        // Atualizar select de alunos
        function updateStudentSelect() {
            const select = document.getElementById('student-select');
            select.innerHTML = '<option value="">Selecione um aluno</option>';

            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        // Exibir alunos
        function displayStudents() {
            const container = document.getElementById('students-list');

            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2rem; margin-top: 40px;">Nenhum aluno cadastrado ainda. 📚</p>';
                return;
            }

            container.innerHTML = '';

            students.forEach(student => {
                const evolutionLevel = getEvolutionLevel(student.totalPoints);
                const pokemonInfo = getPokemonInfo(student.pokemonType, evolutionLevel);
                const progressToNext = student.totalPoints % 100;

                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-points">${student.totalPoints} pontos</div>
                    </div>
                    <div class="pokemon-info">
                        <div class="pokemon-sprite">
                            <img src="${pokemonInfo.image}" alt="${pokemonInfo.name}" class="pokemon-image" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">
                            <div style="display:none; font-size: 2rem;">${pokemonInfo.emoji}</div>
                        </div>
                        <div class="pokemon-details">
                            <div class="pokemon-name">${pokemonInfo.name}</div>
                            <div class="evolution-level">
                                ${evolutionLevel < 2 ?
                        `Faltam ${100 - progressToNext} pontos para evoluir` :
                        'Pokémon totalmente evoluído!'
                    }
                            </div>
                            ${evolutionLevel < 2 ?
                        `<div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressToNext}%"></div>
                                </div>` : ''
                    }
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Exibir ranking
        async function displayRanking() {
            const container = document.getElementById('ranking-list');
            const filter = document.getElementById('pokemon-filter').value;

            try {
                const response = await apiRequest(`/ranking?pokemon=${filter}&limit=5`);
                const ranking = response.data;

                if (ranking.length === 0) {
                    const pokemonNames = {
                        'all': '🌟 Ranking Geral',
                        'bulbasaur': '🌱 Família Bulbasaur',
                        'charmander': '🔥 Família Charmander',
                        'squirtle': '💧 Família Squirtle'
                    };
                    container.innerHTML = `<p style="text-align: center; color: #666; font-size: 1.2rem; margin-top: 40px;">Nenhum aluno encontrado para ${pokemonNames[filter]}. 🔍</p>`;
                    return;
                }

                container.innerHTML = '';

                // Título do ranking baseado no filtro
                const titleElement = document.createElement('div');
                titleElement.style.cssText = 'text-align: center; margin-bottom: 25px; font-size: 1.2rem; color: #667eea; font-weight: 600;';
                if (filter === 'all') {
                    titleElement.textContent = '🌟 Ranking Geral - Top 5';
                } else {
                    const pokemonNames = {
                        'bulbasaur': '🌱 Ranking Família Bulbasaur',
                        'charmander': '🔥 Ranking Família Charmander',
                        'squirtle': '💧 Ranking Família Squirtle'
                    };
                    titleElement.textContent = pokemonNames[filter];
                }
                container.appendChild(titleElement);

                ranking.forEach((student, index) => {
                    const evolutionLevel = getEvolutionLevel(student.totalPoints);
                    const pokemonInfo = getPokemonInfo(student.pokemonType, evolutionLevel);

                    const item = document.createElement('div');
                    item.className = 'ranking-item';
                    item.innerHTML = `
                        <div class="ranking-number">${index + 1}</div>
                        <div class="pokemon-sprite">${pokemonInfo.emoji}</div>
                        <div style="flex: 1;">
                            <div class="student-name">${student.name}</div>
                            <div class="pokemon-name">${pokemonInfo.name}</div>
                        </div>
                        <div class="student-points">${student.totalPoints} pontos</div>
                    `;
                    container.appendChild(item);
                });

            } catch (error) {
                showMessage('Erro ao carregar ranking: ' + error.message, 'error');
                container.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.2rem; margin-top: 40px;">Erro ao carregar ranking. 🏆</p>';
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await loadStudents();
                await loadCreatedActivities();
                displayStudents();
                updateStudentSelect();
                updateActivitySelect();
            } catch (error) {
                showMessage('Erro ao carregar dados iniciais: ' + error.message, 'error');
            }
        });
    </script>
</body>

</html>